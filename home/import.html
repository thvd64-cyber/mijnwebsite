<!-- ======================= home/import.html ======================= -->
<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8"> <!-- Tekencodering UTF-8 -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> <!-- Responsief op mobiel/tablet/desktop -->
    <title>MyFamTreeCollab - Import</title> <!-- Browser tab titel -->
    <link rel="stylesheet" href="../css/style.css"> <!-- Verbindt de externe CSS voor styling -->
</head>
<body>
<!-- ======================= layout/TopBar.html ======================= -->
<div id="topbar-placeholder"></div>  <!-- container voor TopBar content -->
<script>
fetch('/MyFamTreeCollab/Layout/TopBar.html')  // Haalt TopBar HTML op
    .then(resp => resp.text())                // Converteer response naar tekst
    .then(data => {                           
        document.getElementById('topbar-placeholder').innerHTML = data;  // Injecteer TopBar in DOM
    });
</script>

<!-- ======================= layout/Navbar.html ======================= -->
<div id="Navbar-placeholder"></div> <!-- container voor Navbar -->
<script>
fetch('/MyFamTreeCollab/Layout/Navbar.html') // Haal Navbar op
    .then(resp => resp.text())               // Converteer naar tekst
    .then(data => {
        const placeholder = document.getElementById('Navbar-placeholder'); // placeholder ophalen
        if (placeholder) placeholder.innerHTML = data; // injecteer Navbar
        else console.error('Navbar-placeholder niet gevonden'); // fallback debug
    });
</script>

<!-- ======================= Pagina Titel ======================= -->
<div id="pageTitle" style="font-size:1.5rem; font-weight:bold; margin-bottom:15px;"></div>
<script>
document.addEventListener('DOMContentLoaded', () => {
    const pageTitleDiv = document.getElementById('pageTitle');  // doel div
    const title = "Import";                                      // titel tekst
    pageTitleDiv.textContent = title
        .replace(/[-_]/g,' ')                                    // vervang streepjes/underscores door spaties
        .replace(/\b\w/g, c => c.toUpperCase());                 // hoofdletter per woord
});
</script>

<!-- ======================= MAIN CONTENT ======================= -->
<main>
        <section>
        <label for="csvFileInput">Selecteer CSV-bestand:</label> <!-- label voor file input -->
        <input type="file" id="csvFileInput" accept=".csv"> <!-- bestand input -->
        <button id="uploadBtn">Upload & Verwerk CSV</button> <!-- upload knop, gekoppeld aan import.js -->
        <p id="importStatus" style="margin-top:10px; font-weight:bold;"></p> <!-- status / feedback element -->
    </section

    <section>
        <p>
            Na het importeren kunt u de gegevens bekijken in 
            <a href="/MyFamTreeCollab/stamboom/view.html">View</a> 
            of bewerken in 
            <a href="/MyFamTreeCollab/stamboom/manage.html">Manage</a>.
        </p>
    </section>
</main>

<!-- ======================= layout/Footer.html ======================= -->
<div id="footer-placeholder"></div> <!-- container voor Footer content -->
<script>
fetch('/MyFamTreeCollab/Layout/Footer.html')  // Haal footer HTML op
    .then(resp => resp.text())                // converteer naar tekst
    .then(data => {
        document.getElementById('footer-placeholder').innerHTML = data; // injecteer footer
    });
</script>

<!-- ======================= IMPORT JS ======================= -->
<script src="../js/import.js"></script> <!-- originele import logica -->
<script>
document.addEventListener('DOMContentLoaded', ()=>{
    // DOM-elementen ophalen
    const fileInput = document.getElementById('csvFileInput');  // file input element
    const uploadBtn = document.getElementById('uploadBtn');     // upload knop
    const status = document.getElementById('importStatus');     // element voor status feedback

    // Functie om CSV bestand te verwerken
    function handleFile(file){
        if(!file) return;                                      // stop als er geen bestand is geselecteerd
        const reader = new FileReader();                       // FileReader om CSV in te lezen
        reader.onload = function(event){
            const text = event.target.result;                  // CSV tekst ophalen
            let lines = text.split(/\r?\n/).filter(l=>l.trim()!==""); // split in regels en verwijder lege regels
            const importedData = [];                            // buffer voor nieuwe personen
            const existingData = JSON.parse(sessionStorage.getItem('stamboomData') || "[]"); // huidige dataset ophalen
            if(lines.length > 500){ lines = lines.slice(0,500); status.textContent = "⚠️ Alleen de eerste 500 rijen worden geïmporteerd."; } // max 500

            // Verwerk elke CSV regel
            lines.forEach((line,index)=>{
                const person = StamboomSchema.fromCSV(line);    // converteer CSV naar object volgens schema
                if(!person){ console.warn(`Rij ${index+1} kon niet verwerkt worden.`); return; } // parsing check
                if(!person.PartnerID) person.PartnerID = StamboomSchema.stringifyPartners([]); // lege partner array indien nodig
                if(!person.Geslacht) person.Geslacht = 'X';       // default geslacht
                if(!person.ID || existingData.some(p=>p.ID===person.ID)) person.ID = window.genereerCode(person,existingData); // unieke ID
                if(!existingData.some(p=>p.ID===person.ID)){ existingData.push(person); importedData.push(person); } // toevoegen
            });

            // Opslaan in sessionStorage
            sessionStorage.setItem('stamboomData', JSON.stringify(existingData));
            // Statusmelding voor gebruiker
            status.textContent = importedData.length 
                ? `✅ CSV geladen: ${importedData.length} personen toegevoegd.` 
                : `⚠️ Geen nieuwe personen toegevoegd.`;
        };
        reader.onerror = function(){ status.textContent = "❌ Fout bij het lezen van het bestand."; }; // foutmelding
        reader.readAsText(file);                                  // start lezen van CSV
    }

    // Event listener upload knop
    uploadBtn.addEventListener('click', ()=>{
        const file = fileInput.files[0];   // pak geselecteerd bestand
        handleFile(file);                  // verwerk bestand
    });
});
</script>
    <!-- ======================= CORE STORAGE ======================= -->
<script src="../js/storage.js"></script> <!-- Laadt StamboomStorage (localStorage API) -->

<!-- ======================= SCHEMA ======================= -->
<script src="../js/schema.js"></script> <!-- Laadt CSV ↔ object conversie logica -->

<!-- ======================= ID GENERATOR ======================= -->
<script src="../js/idGenerator.js"></script> <!-- Laadt unieke ID generator (window.genereerCode) -->

<!-- ======================= IMPORT LOGICA ======================= -->
<script src="../js/import.js"></script> <!-- Laadt CSV import logica (gebruikt bovenstaande dependencies) -->
</body>
</html>
