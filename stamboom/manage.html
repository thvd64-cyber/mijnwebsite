<!-- ======================= stamboom/manage.html v1.0.3 ======================= -->
<!-- .1 Preview  + warning message verwijderd  -->
<!-- .2 ID: '' & relatie '' zijn leeg, gebruiker kan later invullen  -->
<!-- .3 added tree layout CSS  -->

<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8"> <!-- Tekencodering UTF-8 -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> <!-- Responsief op mobiel/tablet/desktop -->
    <title>MyFamTreeCollab - Manage</title> <!-- Browser tab titel -->
    <link rel="stylesheet" href="../css/style.css"> <!-- Verbinden met CSS voor styling -->
</head>
<body>
<!-- ======================= layout/TopBar.html ======================= -->
<div id="topbar-placeholder"></div> <!-- container voor TopBar content -->
<script>
fetch('/MyFamTreeCollab/Layout/TopBar.html')  // fetch TopBar HTML
    .then(resp => resp.text())                // response naar tekst omzetten
    .then(data => document.getElementById('topbar-placeholder').innerHTML = data); // injecteer in DOM
</script>

<!-- ======================= layout/Navbar.html ======================= -->
<div id="Navbar-placeholder"></div> <!-- container voor Navbar content -->
<script>
fetch('/MyFamTreeCollab/Layout/Navbar.html')  // fetch Navbar HTML
    .then(resp => resp.text())                // response naar tekst
    .then(data => {
        const placeholder = document.getElementById('Navbar-placeholder'); // placeholder ophalen
        if(placeholder) placeholder.innerHTML = data; // injecteer Navbar
        else console.error('Navbar-placeholder niet gevonden'); // fallback debug
    });
</script>

<!-- ======================= Pagina Titel ======================= -->
<div id="pageTitle" style="font-size:1.5rem; font-weight:bold; margin-bottom:15px;"></div>
<script>
document.addEventListener('DOMContentLoaded', () => {
    const pageTitleDiv = document.getElementById('pageTitle'); // doel div
    const title = "Manage Stamboom"; // titel
    pageTitleDiv.textContent = title.replace(/[-_]/g,' ').replace(/\b\w/g, c=>c.toUpperCase()); // netjes hoofdletter
});
</script>

<!-- ======================= MAIN CONTENT ======================= -->
<main>
    <div class="container">
        <!-- Zoek en Acties -->
        <input type="text" id="searchPerson" placeholder="Voer ID of naam in"> <!-- input search -->
        <button id="loadBtn">Laad Persoon</button> <!-- laad specifieke persoon -->
        <button id="refreshBtn">Refresh</button> <!-- refresh tabel -->
        <button id="addBtn">+ Toevoegen</button> <!-- nieuwe persoon toevoegen -->
        <button id="saveBtn">Opslaan</button> <!-- alle wijzigingen opslaan -->

        <!-- Hier komt de relation tree -->
        <div id="tree"></div> <!-- container voor tree.js -->

        <!-- Manage Tabel -->
        <table id="manageTable" style="width:100%; border-collapse:collapse;">
            <thead><tr></tr></thead> <!-- dynamisch gevuld via JS -->
            <tbody></tbody> <!-- rijen worden dynamisch toegevoegd -->
        </table>
    </div>

    <!-- ======================= tree layout CSS ======================= -->
    <style>
    .tree-node{padding:6px 12px;margin:5px;border-radius:6px;color:white;cursor:pointer;font-family:Arial;} /* node styling */
    .main{background:#1976D2;}      /* blauw voor hoofdpersoon */
    .parent{background:#388E3C;}    /* groen voor ouders */
    .partner{background:#7B1FA2;}   /* paars voor partners */
    .child{background:#F57C00;}     /* oranje voor kinderen */
    .sibling{background:#FBC02D;color:black;} /* geel voor siblings */
    .tree-layer{min-height:40px;display:flex;justify-content:center;margin:20px 0;} /* horizontale rij layout */
    </style>
</main>

<!-- ======================= Load JS ======================= -->
<script src="../js/schema.js"></script> <!-- StamboomSchema structuur -->
<script src="../js/idGenerator.js"></script> <!-- ID generator -->
<script src="../js/storage.js"></script> <!-- StamboomStorage module -->

<script type="module">
import { renderTree } from "../js/tree.js"; // relation builder module

document.addEventListener('DOMContentLoaded', ()=>{
    const dataset = StamboomStorage.get(); // haal data uit storage
    if(dataset.length){
        const hoofdId = dataset[0].ID; // start bij eerste persoon (Hoofd-ID)
        renderTree(dataset, hoofdId, "tree"); // render de boom in div#tree
    }
});
</script>

<script>
document.addEventListener('DOMContentLoaded', ()=>{ // wacht tot DOM geladen

    // ======================= DOM ELEMENTEN =======================
    const tableBody = document.querySelector('#manageTable tbody'); // doel tbody voor rijen
    const theadRow = document.querySelector('#manageTable thead tr'); // doel voor headers
    const addBtn = document.getElementById('addBtn'); // nieuwe persoon knop
    const refreshBtn = document.getElementById('refreshBtn'); // refresh tabel knop
    const saveBtn = document.getElementById('saveBtn'); // opslaan knop
    const loadBtn = document.getElementById('loadBtn'); // laad persoon knop
    const searchInput = document.getElementById('searchPerson'); // zoekveld
    const confirmBtn = document.getElementById('confirmBtn'); // confirm knop
    const warningMessage = document.getElementById('warningMessage'); // waarschuwing div

    // ======================= INIT DATA =======================
    let dataset = StamboomStorage.get(); // haal data uit storage

    // =======================
    // BUILD HEADER FUNCTIE
    // =======================
    function buildHeader(){
        theadRow.innerHTML = ''; // lege header eerst
        const thRel = document.createElement('th'); // eerste kolom: Relatie
        thRel.textContent = 'Relatie'; // tekst
        theadRow.appendChild(thRel); // toevoegen aan header
        StamboomSchema.fields.forEach(field => { // loop over alle schema velden
            const th = document.createElement('th'); // maak th element
            th.textContent = field; // veldnaam als kolomnaam
            theadRow.appendChild(th); // voeg toe aan header
        });
    }

    // ======================= TABEL RENDEREN =======================
    function renderTable(data){
        buildHeader(); // header altijd eerst renderen
        tableBody.innerHTML = ''; // tbody leegmaken
        if(data.length === 0){ // geen data aanwezig
            // colspan = Relatie kolom + alle schema velden
            tableBody.innerHTML = '<tr><td colspan="'+(StamboomSchema.fields.length+1)+'">Geen personen gevonden</td></tr>'; 
            return;
        }
        data.forEach(p =>{ // voor elke persoon
            const tr = document.createElement('tr'); // nieuwe rij
            tr.dataset.id = p.ID; // rij-ID

            // Relatie kolom view-only
            const tdRel = document.createElement('td');
            tdRel.textContent = p.Relatie || '';
            tr.appendChild(tdRel); // eerste kolom toevoegen

            // velden uit schema
            StamboomSchema.fields.forEach(f =>{
                const td = document.createElement('td'); // cel maken
                if(f==='ID'){ td.textContent = p[f] || ''; } // readonly ID
                else{
                    const input = document.createElement('input'); // input voor editable velden
                    input.value = p[f] || ''; // vul waarde
                    input.addEventListener('change', e=> p[f]=e.target.value); // update object bij wijziging
                    td.appendChild(input); // voeg toe aan cel
                }
                tr.appendChild(td); // voeg cel toe aan rij
            });

            tableBody.appendChild(tr); // voeg rij toe aan tabel
        });
    }

    renderTable(dataset); // initial render van tabel

    // ======================= REFRESH KNOP =======================
    refreshBtn.addEventListener('click', ()=>{
        dataset = StamboomStorage.get(); // opnieuw ophalen
        renderTable(dataset); // render opnieuw
    });

    // ======================= OPSLAAN =======================
    saveBtn.addEventListener('click', ()=>{
        StamboomStorage.set(dataset); // schrijf dataset naar storage
        alert('Wijzigingen opgeslagen!'); // feedback
    });

    // ======================= TOEVOEGEN NIEUWE PERSOON =======================
    addBtn.addEventListener('click', ()=>{
        const newPerson = { // default nieuw persoon
            ID: '', // leeg, gebruiker kan later invullen
            Doopnaam:'', Roepnaam:'', Prefix:'', Achternaam:'', Geslacht:'', Geboortedatum:'', Relatie:'', PartnerID:[]
        };
        dataset.push(newPerson); // direct toevoegen aan dataset
        StamboomStorage.set(dataset); // opslaan in storage
        renderTable(dataset); // render tabel opnieuw
    });

    // ======================= CONFIRM NIEUWE PERSOON =======================
    confirmBtn.addEventListener('click', ()=>{
        const person = JSON.parse(previewContent.textContent); // parse JSON
        dataset.push(person); // voeg toe aan dataset
        StamboomStorage.set(dataset); // update storage
        renderTable(dataset); // render tabel opnieuw
    });

    // ======================= ZOEK FUNCTIE =======================
    loadBtn.addEventListener('click', ()=>{
        const term = searchInput.value.trim().toLowerCase(); // zoekterm
        const filtered = dataset.filter(p => 
            p.ID.toLowerCase().includes(term) ||
            p.Doopnaam.toLowerCase().includes(term) ||
            p.Roepnaam.toLowerCase().includes(term) ||
            p.Achternaam.toLowerCase().includes(term)
        );
        renderTable(filtered); // render gefilterde dataset
    });

});
</script>

<!-- ======================= FOOTER ======================= -->
<div id="footer-placeholder"></div>
<script>
fetch('/MyFamTreeCollab/Layout/Footer.html') // fetch footer
    .then(resp=>resp.text())
    .then(data=>document.getElementById('footer-placeholder').innerHTML=data); // injecteer footer
</script>

</body>
</html>
