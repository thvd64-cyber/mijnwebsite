<!-- ======================= stamboom/manage.html v1.0.5 â€“ WORKING AUTO RELATIE ======================= -->
<!--.4 AUTO RELATIE  -->
<!--.4 Functionaliteit voor +Toevoegen, Opslaan, Refresh, Search blijft volledig operationeel.  -->
<!--.4 De tree.js rendering blijft intact in div#tree.  -->
<!--.5 Tree-div en tree.js import volledig verwijderd.-->
<!--.5 Relatie wordt automatisch toegewezen via assignRelation().-->
<!--.5 Rijkleuren voor hoofd, ouders, partner, kind en siblings blijven actief.-->
<!--.5 unctionaliteit +Toevoegen, Opslaan, Refresh en Search blijft volledig operationeel.-->

<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8"> <!-- Tekencodering UTF-8 -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> <!-- Responsief op mobiel/tablet/desktop -->
    <title>MyFamTreeCollab - Manage</title> <!-- Browser tab titel -->
    <link rel="stylesheet" href="../css/style.css"> <!-- Verbinden met CSS voor styling -->
    <style>
    /* ======================= TREE NODE COLORS ======================= */
    .main{background:#1976D2;color:white;}      /* blauw voor hoofdpersoon */
    .parent{background:#388E3C;color:white;}    /* groen voor ouders */
    .partner{background:#7B1FA2;color:white;}   /* paars voor partners */
    .child{background:#F57C00;color:white;}     /* oranje voor kinderen */
    .sibling{background:#FBC02D;color:black;}   /* geel voor siblings */
    </style>
</head>
<body>
<!-- ======================= layout/TopBar.html ======================= -->
<div id="topbar-placeholder"></div>
<script>
fetch('/MyFamTreeCollab/Layout/TopBar.html')
    .then(resp => resp.text())
    .then(data => document.getElementById('topbar-placeholder').innerHTML = data);
</script>

<!-- ======================= layout/Navbar.html ======================= -->
<div id="Navbar-placeholder"></div>
<script>
fetch('/MyFamTreeCollab/Layout/Navbar.html')
    .then(resp => resp.text())
    .then(data => {
        const placeholder = document.getElementById('Navbar-placeholder');
        if(placeholder) placeholder.innerHTML = data;
        else console.error('Navbar-placeholder niet gevonden');
    });
</script>

<!-- ======================= Pagina Titel ======================= -->
<div id="pageTitle" style="font-size:1.5rem; font-weight:bold; margin-bottom:15px;"></div>
<script>
document.addEventListener('DOMContentLoaded', () => {
    const pageTitleDiv = document.getElementById('pageTitle');
    const title = "Manage Stamboom";
    pageTitleDiv.textContent = title.replace(/[-_]/g,' ').replace(/\b\w/g, c=>c.toUpperCase());
});
</script>

<!-- ======================= MAIN CONTENT ======================= -->
<main>
    <div class="container">
        <!-- Zoek en Acties -->
        <input type="text" id="searchPerson" placeholder="Voer ID of naam in">
        <button id="loadBtn">Laad Persoon</button>
        <button id="refreshBtn">Refresh</button>
        <button id="addBtn">+ Toevoegen</button>
        <button id="saveBtn">Opslaan</button>

        <!-- Hier komt de relation tree -->
        <div id="tree"></div>

        <!-- Manage Tabel -->
        <table id="manageTable" style="width:100%; border-collapse:collapse;">
            <thead><tr></tr></thead>
            <tbody></tbody>
        </table>
    </div>
</main>

<!-- ======================= Load JS ======================= -->
<script src="../js/schema.js"></script>
<script src="../js/idGenerator.js"></script>
<script src="../js/storage.js"></script>
<script>
document.addEventListener('DOMContentLoaded', ()=>{

    // ======================= DOM ELEMENTEN =======================
    const tableBody = document.querySelector('#manageTable tbody');
    const theadRow = document.querySelector('#manageTable thead tr');
    const addBtn = document.getElementById('addBtn');
    const refreshBtn = document.getElementById('refreshBtn');
    const saveBtn = document.getElementById('saveBtn');
    const loadBtn = document.getElementById('loadBtn');
    const searchInput = document.getElementById('searchPerson');

    // ======================= INIT DATA =======================
    let dataset = StamboomStorage.get();

    // ======================= BUILD HEADER =======================
    function buildHeader(){
        theadRow.innerHTML = '';
        const thRel = document.createElement('th');
        thRel.textContent = 'Relatie';
        theadRow.appendChild(thRel);
        StamboomSchema.fields.forEach(field=>{
            const th = document.createElement('th');
            th.textContent = field;
            theadRow.appendChild(th);
        });
    }

    // ======================= AUTOMATISCHE RELATIE FUNCTIE =======================
    function assignRelation(p){
        if(!p.VaderID && !p.MoederID) return 'main';
        const isParent = dataset.some(x => x.VaderID===p.ID || x.MoederID===p.ID);
        if(isParent) return 'parent';
        const isPartner = dataset.some(x => (x.PartnerID||[]).includes(p.ID));
        if(isPartner) return 'partner';
        if((p.VaderID && dataset.some(x=>x.ID===p.VaderID)) || (p.MoederID && dataset.some(x=>x.ID===p.MoederID))) return 'child';
        const siblings = dataset.filter(x=>x.ID!==p.ID && ((x.VaderID && x.VaderID===p.VaderID) || (x.MoederID && x.MoederID===p.MoederID)));
        if(siblings.length>0) return 'sibling';
        return '';
    }

    // ======================= RENDER TABEL =======================
    function renderTable(data){
        buildHeader();
        tableBody.innerHTML = '';

        if(data.length === 0){
            tableBody.innerHTML = '<tr><td colspan="'+(StamboomSchema.fields.length+1)+'">Geen personen gevonden</td></tr>';
            return;
        }

        data.forEach(p=>{
            const tr = document.createElement('tr');
            tr.dataset.id = p.ID;

            // ======================= RELATIE + KLEUR =======================
            const relationClass = assignRelation(p);
            if(relationClass) tr.classList.add(relationClass);
            const tdRel = document.createElement('td');
            tdRel.textContent = relationClass.charAt(0).toUpperCase()+relationClass.slice(1);
            tr.appendChild(tdRel);

            // ======================= VELDEN =======================
            StamboomSchema.fields.forEach(f=>{
                const td = document.createElement('td');
                if(f==='ID'){ td.textContent = p[f] || ''; }
                else{
                    const input = document.createElement('input');
                    input.value = p[f] || '';
                    input.addEventListener('change', e=> p[f]=e.target.value);
                    td.appendChild(input);
                }
                tr.appendChild(td);
            });

            tableBody.appendChild(tr);
        });
    }

    renderTable(dataset); // eerste render

    // ======================= REFRESH KNOP =======================
    refreshBtn.addEventListener('click', ()=>{
        dataset = StamboomStorage.get();
        renderTable(dataset);
    });

    // ======================= OPSLAAN =======================
    saveBtn.addEventListener('click', ()=>{
        StamboomStorage.set(dataset);
        alert('Wijzigingen opgeslagen!');
    });

    // ======================= TOEVOEGEN NIEUWE PERSOON =======================
    addBtn.addEventListener('click', ()=>{
        const newPerson = {
            ID:'', Doopnaam:'', Roepnaam:'', Prefix:'', Achternaam:'', Geslacht:'', Geboortedatum:'', Relatie:''
        };
        dataset.push(newPerson);
        StamboomStorage.set(dataset);
        renderTable(dataset);
    });

    // ======================= ZOEK FUNCTIE =======================
    loadBtn.addEventListener('click', ()=>{
        const term = searchInput.value.trim().toLowerCase();
        const filtered = dataset.filter(p =>
            (p.ID||'').toLowerCase().includes(term) ||
            (p.Doopnaam||'').toLowerCase().includes(term) ||
            (p.Roepnaam||'').toLowerCase().includes(term) ||
            (p.Achternaam||'').toLowerCase().includes(term)
        );
        renderTable(filtered);
    });

});
</script>
<!-- ======================= FOOTER ======================= -->
<div id="footer-placeholder"></div>
<script>
fetch('/MyFamTreeCollab/Layout/Footer.html')
    .then(resp=>resp.text())
    .then(data=>document.getElementById('footer-placeholder').innerHTML=data);
</script>

</body>
</html>
