<!DOCTYPE html>
<html lang="nl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Stamboom - MyFamTreeCollab</title>
    <link rel="stylesheet" href="../css/style.css">
    <style>
        /* Kleurcodes per relatie */
        .ouders { background-color: #008080; color: white; }
        .hoofd-id { background-color: #FFD700; }
        .partner { background-color: #d3d3d3; }
        .kind { background-color: #90EE90; }
        .ex-partner { background-color: #A9A9A9; }
        .broerzus { background-color: #FFFDD0; }
        .partner-kind { background-color: #D8BFD8; }

        table { border-collapse: collapse; width: 100%; margin-top: 20px; }
        th, td { border: 1px solid #999; padding: 5px; text-align: left; }
        th { background-color: #eee; }
        input, select, textarea { width: 100%; }
        .btn { padding: 6px 12px; margin: 5px; cursor: pointer; }
    </style>
</head>

<body>

    <!-- NAVBAR -->
    <div id="navbar"></div>
    <script>
        fetch('../navbar.html')
            .then(response => response.text())
            .then(data => document.getElementById('navbar').innerHTML = data);
    </script>

    <!-- MAIN -->
    <main>
        <h2>Manage Stamboom</h2>
        <p>Laad een persoon via ID of naam om de tweede graad familie te beheren.</p>

        <input type="text" id="searchPerson" placeholder="Voer ID of naam in">
        <button id="loadBtn">Laad Persoon</button>
        <button id="refreshBtn" class="btn">Refresh</button>
        <button id="saveBtn" class="btn">Opslaan</button>
        <button id="addBtn" class="btn">+ Toevoegen</button>

        <table id="manageTable">
            <thead>
                <tr>
                    <th>Relatie</th>
                    <th>ID</th>
                    <th>Doopnaam</th>
                    <th>Roepnaam</th>
                    <th>Prefix</th>
                    <th>Achternaam</th>
                    <th>Geslacht</th>
                    <th>Geboortedatum</th>
                    <th>Geboorteplaats</th>
                    <th>Overlijdensdatum</th>
                    <th>Overlijdensplaats</th>
                    <th>VaderID</th>
                    <th>MoederID</th>
                    <th>PartnerID</th>
                    <th>Huwelijksdatum</th>
                    <th>Huwelijksplaats</th>
                    <th>Opmerkingen</th>
                    <th>Adres</th>
                    <th>ContactInfo</th>
                    <th>URL</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </main>

    <!-- SCRIPT -->
    <script src="../js/idGenerator.js"></script>
    <script>
        let stamboomData = JSON.parse(localStorage.getItem('stamboomData') || '[]');
        const tableBody = document.querySelector('#manageTable tbody');
        const loadBtn = document.getElementById('loadBtn');
        const searchInput = document.getElementById('searchPerson');
        const saveBtn = document.getElementById('saveBtn');
        const refreshBtn = document.getElementById('refreshBtn');
        const addBtn = document.getElementById('addBtn');

        function getRowClass(p) {
            switch (p.Relatie) {
                case 'Ouder': return 'ouders';
                case 'Hoofd-ID': return 'hoofd-id';
                case 'Partner': return 'partner';
                case 'Kind': return 'kind';
                case 'Ex-Partner': return 'ex-partner';
                case 'Broer/Zus': return 'broerzus';
                case 'Partner-Kind': return 'partner-kind';
                default: return '';
            }
        }

        function ensureRelationship(person) {
            if (!person.Relatie) {
                if (!person.VaderID && !person.MoederID) person.Relatie = 'Hoofd-ID';
                else if (person.VaderID || person.MoederID) person.Relatie = 'Kind';
                else person.Relatie = '';
            }
        }

        function renderTable(filteredData) {
            tableBody.innerHTML = '';
            filteredData.forEach(p => {
                ensureRelationship(p);
                const tr = document.createElement('tr');
                tr.className = getRowClass(p);

                const fields = ['Relatie','ID','Doopnaam','Roepnaam','Prefix','Achternaam','Geslacht',
                    'Geboortedatum','Geboorteplaats','Overlijdensdatum','Overlijdensplaats',
                    'VaderID','MoederID','PartnerID','Huwelijksdatum','Huwelijksplaats','Opmerkingen','Adres','ContactInfo','URL'];

                fields.forEach(f => {
                    const td = document.createElement('td');
                    if (f === 'ID' || f === 'Relatie') {
                        td.textContent = p[f] || '';
                    } else {
                        const input = document.createElement('input');
                        input.value = p[f] || '';
                        input.addEventListener('change', e => { p[f] = e.target.value; });
                        td.appendChild(input);
                    }
                    tr.appendChild(td);
                });

                tableBody.appendChild(tr);
            });
        }

        function loadPerson() {
            const term = searchInput.value.toLowerCase();
            const filtered = stamboomData.filter(p =>
                p.ID.toLowerCase() === term ||
                p.Roepnaam?.toLowerCase() === term ||
                p.Doopnaam?.toLowerCase() === term
            );
            if (filtered.length === 0) alert('Persoon niet gevonden');
            else renderTable(filtered);
        }

        function saveData() {
            tableBody.querySelectorAll('tr').forEach(tr => {
                const tds = tr.querySelectorAll('td');
                const fields = ['Relatie','ID','Doopnaam','Roepnaam','Prefix','Achternaam','Geslacht',
                    'Geboortedatum','Geboorteplaats','Overlijdensdatum','Overlijdensplaats',
                    'VaderID','MoederID','PartnerID','Huwelijksdatum','Huwelijksplaats','Opmerkingen','Adres','ContactInfo','URL'];
                let p = {};
                tds.forEach((td, i) => {
                    if (fields[i] === 'ID' || fields[i] === 'Relatie') p[fields[i]] = td.textContent;
                    else p[fields[i]] = td.querySelector('input').value;
                });
                if (!p.ID) { 
                    try { p.ID = idGenerator(p.Doopnaam, p.Roepnaam, p.Achternaam, p.Geslacht || 'X'); }
                    catch { p.ID = 'X000000'; }
                }
                ensureRelationship(p);
                const idx = stamboomData.findIndex(x => x.ID === p.ID);
                if (idx !== -1) stamboomData[idx] = p;
                else stamboomData.push(p);
            });
            localStorage.setItem('stamboomData', JSON.stringify(stamboomData));
            alert('Wijzigingen opgeslagen!');
        }

        function refreshTable() {
            const term = searchInput.value.toLowerCase();
            if (!term && stamboomData.length > 0) renderTable([stamboomData[0]]);
            else loadPerson();
        }

        // Voeg lege rij toe
        function addNewPerson() {
            const emptyPerson = { Relatie:'Hoofd-ID', ID:'', Doopnaam:'', Roepnaam:'', Prefix:'', Achternaam:'', Geslacht:'', 
                Geboortedatum:'', Geboorteplaats:'', Overlijdensdatum:'', Overlijdensplaats:'',
                VaderID:'', MoederID:'', PartnerID:'', Huwelijksdatum:'', Huwelijksplaats:'', Opmerkingen:'', Adres:'', ContactInfo:'', URL:'' };
            renderTable([emptyPerson].concat(stamboomData));
        }

        loadBtn.addEventListener('click', loadPerson);
        saveBtn.addEventListener('click', saveData);
        refreshBtn.addEventListener('click', refreshTable);
        addBtn.addEventListener('click', addNewPerson);

        if (stamboomData.length > 0) renderTable([stamboomData[0]]);
    </script>
</body>

</html>
