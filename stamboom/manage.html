<!-- ======================= stamboom/manage.html ======================= -->
<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8"> <!-- Tekencodering UTF-8 -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> <!-- Responsief op mobiel/tablet/desktop -->
    <title>MyFamTreeCollab - Manage</title> <!-- Browser tab titel -->
    <link rel="stylesheet" href="../css/style.css"> <!-- Verbinden met CSS voor styling -->
</head>
<body>
<!-- ======================= layout/TopBar.html ======================= -->
<div id="topbar-placeholder"></div> <!-- container voor TopBar content -->
<script>
fetch('/MyFamTreeCollab/Layout/TopBar.html')  // fetch TopBar HTML
    .then(resp => resp.text())                // response naar tekst omzetten
    .then(data => document.getElementById('topbar-placeholder').innerHTML = data); // injecteer in DOM
</script>

<!-- ======================= layout/Navbar.html ======================= -->
<div id="Navbar-placeholder"></div> <!-- container voor Navbar content -->
<script>
fetch('/MyFamTreeCollab/Layout/Navbar.html')  // fetch Navbar HTML
    .then(resp => resp.text())                // response naar tekst
    .then(data => {
        const placeholder = document.getElementById('Navbar-placeholder'); // placeholder ophalen
        if(placeholder) placeholder.innerHTML = data; // injecteer Navbar
        else console.error('Navbar-placeholder niet gevonden'); // fallback debug
    });
</script>

<!-- ======================= Pagina Titel ======================= -->
<div id="pageTitle" style="font-size:1.5rem; font-weight:bold; margin-bottom:15px;"></div>
<script>
document.addEventListener('DOMContentLoaded', () => {
    const pageTitleDiv = document.getElementById('pageTitle'); // doel div
    const title = "Manage Stamboom"; // titel
    pageTitleDiv.textContent = title.replace(/[-_]/g,' ').replace(/\b\w/g, c=>c.toUpperCase()); // netjes hoofdletter
});
</script>

<!-- ======================= MAIN CONTENT ======================= -->
<main>
    <div class="container">
        <!-- Zoek en Acties -->
        <input type="text" id="searchPerson" placeholder="Voer ID of naam in"> <!-- input search -->
        <button id="loadBtn">Laad Persoon</button> <!-- laad specifieke persoon -->
        <button id="refreshBtn">Refresh</button> <!-- refresh tabel -->
        <button id="addBtn">+ Toevoegen</button> <!-- nieuwe persoon toevoegen -->
        <button id="saveBtn">Opslaan</button> <!-- alle wijzigingen opslaan -->

        <!-- Manage Tabel -->
        <table id="manageTable" style="width:100%; border-collapse:collapse;">
            <thead><tr></tr></thead> <!-- dynamisch gevuld via JS -->
            <tbody></tbody> <!-- rijen worden dynamisch toegevoegd -->
        </table>

        <!-- Preview / Confirm Sectie -->
        <div id="personPreview" style="display:none; margin-top:20px; padding:10px; border:1px solid #ccc; border-radius:5px;">
            <h3>Bevestig de persoon</h3>
            <pre id="previewContent"></pre> <!-- JSON preview -->
            <button id="confirmBtn">Bevestigen & Ga naar Manage</button> <!-- bevestig persoon -->
        </div>

        <!-- Warning Message -->
        <div id="warningMessage" style="display:none; color:red; margin-top:10px;"></div> <!-- waarschuwing -->
    </div>
</main>

<!-- ======================= Load JS ======================= -->
<script src="../js/schema.js"></script> <!-- StamboomSchema structuur -->
<script src="../js/idGenerator.js"></script> <!-- ID generator -->
<script src="../js/storage.js"></script> <!-- StamboomStorage module -->

<script>
document.addEventListener('DOMContentLoaded', () => { // wacht tot DOM geladen

    // ======================= DOM ELEMENTEN =======================
    const tableBody = document.querySelector('#manageTable tbody'); // doel tbody voor rijen
    const addBtn = document.getElementById('addBtn'); // nieuwe persoon knop
    const refreshBtn = document.getElementById('refreshBtn'); // refresh tabel knop
    const saveBtn = document.getElementById('saveBtn'); // opslaan knop
    const loadBtn = document.getElementById('loadBtn'); // laad persoon knop
    const searchInput = document.getElementById('searchPerson'); // zoekveld
    const previewDiv = document.getElementById('personPreview'); // preview container
    const previewContent = document.getElementById('previewContent'); // preview JSON
    const confirmBtn = document.getElementById('confirmBtn'); // confirm knop
    const warningMessage = document.getElementById('warningMessage'); // waarschuwing div

    // ======================= TABEL RENDEREN =======================
    function renderTable(data){ // render dataset in tabel
        tableBody.innerHTML = ''; // clear oude rijen

        if(data.length === 0){ // geen data
            tableBody.innerHTML = '<tr><td colspan="'+(StamboomSchema.fields.length+1)+'">Geen personen gevonden</td></tr>';
            return;
        }

        // render elke persoon
        data.forEach(p => {
            const tr = document.createElement('tr'); // nieuwe rij
            tr.dataset.id = p.ID; // row-ID

            // velden uit schema
            StamboomSchema.fields.forEach(f => {
                const td = document.createElement('td'); // cel
                if(f === 'ID'){ // ID readonly
                    td.textContent = p[f] || '';
                } else {
                    const input = document.createElement('input'); // input voor bewerken
                    input.value = p[f] || '';
                    input.addEventListener('change', e => p[f] = e.target.value); // update object
                    td.appendChild(input);
                }
                tr.appendChild(td); // voeg cel toe
            });

            // Relatie kolom (view-only)
            const tdRel = document.createElement('td');
            tdRel.textContent = p.Relatie || '';
            tr.prepend(tdRel); // eerste kolom
            tableBody.appendChild(tr); // voeg rij toe
        });
    }

    // ======================= INIT =======================
    let dataset = StamboomStorage.get(); // haal data uit storage
    renderTable(dataset); // init render

    // ======================= REFRESH KNOP =======================
    refreshBtn.addEventListener('click', ()=>{ // klik refresh
        dataset = StamboomStorage.get(); // opnieuw ophalen
        renderTable(dataset); // renderen
    });

    // ======================= OPSLAAN =======================
    saveBtn.addEventListener('click', ()=>{ // klik opslaan
        StamboomStorage.set(dataset); // schrijf dataset naar storage
        alert('Wijzigingen opgeslagen!'); // feedback
    });

    // ======================= TOEVOEGEN NIEUWE PERSOON =======================
    addBtn.addEventListener('click', ()=>{ // klik + toevoegen
        const newPerson = { // lege default persoon
            ID: 'P'+Date.now(), // uniek ID
            Doopnaam:'', Roepnaam:'', Prefix:'', Achternaam:'', Geslacht:'', Geboortedatum:'', Relatie:'Hoofd-ID', PartnerID:[]
        };
        previewContent.textContent = JSON.stringify(newPerson, null, 2); // JSON preview
        previewDiv.style.display = 'block'; // toon preview
    });

    // ======================= CONFIRM NIEUWE PERSOON =======================
    confirmBtn.addEventListener('click', ()=>{ // bevestig
        const person = JSON.parse(previewContent.textContent); // parse JSON
        dataset.push(person); // voeg toe aan dataset
        StamboomStorage.set(dataset); // update storage
        previewDiv.style.display = 'none'; // verberg preview
        renderTable(dataset); // render tabel opnieuw
    });

    // ======================= ZOEK FUNCTIE =======================
    loadBtn.addEventListener('click', ()=>{ // klik laad
        const term = searchInput.value.trim().toLowerCase(); // zoekterm
        const filtered = dataset.filter(p => 
            p.ID.toLowerCase().includes(term) || 
            p.Doopnaam.toLowerCase().includes(term) ||
            p.Roepnaam.toLowerCase().includes(term) ||
            p.Achternaam.toLowerCase().includes(term)
        );
        renderTable(filtered); // render filtered
    });

});
</script>

<!-- ======================= FOOTER ======================= -->
<div id="footer-placeholder"></div>
<script>
fetch('/MyFamTreeCollab/Layout/Footer.html') // fetch footer
    .then(resp => resp.text())
    .then(data => document.getElementById('footer-placeholder').innerHTML = data);
</script>

</body>
</html>
